# 上位机总体规划（Modbus RTU，DDSU666）

---

## 通信约束与目标

- 串口参数：9600 8N1，无校验；总线半双工，主从应答，单主多从；从站地址为 0x0C（十进制 12）
- 协议与功能码：Modbus RTU；支持 0x03 读寄存器、0x10 写多寄存器；报文需 3.5 字符空闲间隔；CRC16 附帧尾（低字节在前）
- 目标：周期性读取电压、电流、功率、功率因数、频率及有功总电能等浮点量（每项占 2 个寄存器）并实时显示；后续可扩展多从站与历史存储
- 协议探测策略：
  - 初次连接发送标准 Modbus 测试帧（如 0C 03 20 00 00 02）
  - 若无响应或响应异常，再尝试 DL/T645 帧头探测
  - 若确认非 Modbus RTU，提示用户切换协议或检查设备配置
- 参数选择：支持更改常用串口参数（波特率、数据位、停止位、从站地址等），通过写寄存器方式配置，并在 UI 层提供选择界面
- CRC 校验码在程序中自动生成，采用标准 Modbus CRC16 算法（低字节在前，高字节在后）

---

## 数据点与寄存器映射（带类型说明）

| 数据点      | 寄存器地址  | 类型    | 寄存器数 | 说明          |
| -------- | ------ | ----- | ---- | ----------- |
| 电压 U     | 0x2000 | float | 2    | IEEE754 单精度 |
| 电流 I     | 0x2002 | float | 2    | IEEE754 单精度 |
| 有功功率 P   | 0x2004 | float | 2    | IEEE754 单精度 |
| 无功功率 Q   | 0x2006 | float | 2    | IEEE754 单精度 |
| 视在功率 S   | 0x2008 | float | 2    | IEEE754 单精度 |
| 功率因数 PF  | 0x200A | float | 2    | IEEE754 单精度 |
| 频率 Freq  | 0x200E | float | 2    | IEEE754 单精度 |
| 有功总电能 Ep | 0x4000 | float | 2    | IEEE754 单精度 |

> float 类型：占 2 个寄存器（4 字节），需按 IEEE754 单精度浮点数解析，寄存器高位在前，每寄存器内高字节在前

---

## 帧设计规范

- 报文格式：地址(1) + 功能码(1) + 起始寄存器(2，高字节在前) + 数量(2，高字节在前) + CRC(2，低字节在前)
- 从站地址：固定 0x0C
- 读取功能：0x03（读寄存器）
- 写入功能：0x10（写多寄存器），用于后续地址/波特率等配置
- CRC：Modbus CRC16；以下帧中 CRC 用 xx xx 占位
- 超时与重试：建议超时 100–300 ms，重试 2–3 次，失败上报；不同数据点可在同周期合并请求以减少总线占用

---

## 请求/响应帧模板（HEX；数据与 CRC 用 xx）

| 数据点      | 请求帧                       | 响应帧                          |
| -------- | ------------------------- | ---------------------------- |
| 电压 U     | `0C 03 20 00 00 02 xx xx` | `0C 03 04 xx xx xx xx xx xx` |
| 电流 I     | `0C 03 20 02 00 02 xx xx` | `0C 03 04 xx xx xx xx xx xx` |
| 有功功率 P   | `0C 03 20 04 00 02 xx xx` | `0C 03 04 xx xx xx xx xx xx` |
| 无功功率 Q   | `0C 03 20 06 00 02 xx xx` | `0C 03 04 xx xx xx xx xx xx` |
| 视在功率 S   | `0C 03 20 08 00 02 xx xx` | `0C 03 04 xx xx xx xx xx xx` |
| 功率因数 PF  | `0C 03 20 0A 00 02 xx xx` | `0C 03 04 xx xx xx xx xx xx` |
| 频率 Freq  | `0C 03 20 0E 00 02 xx xx` | `0C 03 04 xx xx xx xx xx xx` |
| 有功总电能 Ep | `0C 03 40 00 00 02 xx xx` | `0C 03 04 xx xx xx xx xx xx` |

> 合并读取建议：相邻量可用一帧读多寄存器，如从 0x2000 连读 0x000E（7 个量 ×2 寄存器 = 14 个寄存器），请求为：`0C 03 20 00 00 0E xx xx`，响应为 `0C 03 1C …数据 28 字节… xx xx`

---

## 轮询与异常处理规划

- **轮询节奏**
  
  - 电参量（U/I/P/Q/S/PF/F）：1 秒周期（或 500 ms，视总线与 UI 刷新预算）
  - 电能 Ep：5–10 秒周期即可
  - 合并读取优先，减少总线占用；多从站轮询采用轮转调度与间隔退避
  - 建议轮询周期可在配置层动态调整

- **解析与校准**
  
  - 浮点解析：固定寄存器顺序与每寄存器高字节在前；遇到异常（NaN/Inf/不合理跳变）则丢弃该次样本
  - 端序校准：首次联调用屏显比对修正（如需寄存器对调或字节对调），并在配置层持久化

- **异常机制**
  
  - CRC 错误/超时：丢帧、重试、告警
  - Modbus 异常响应：功能码最高位为 1（如 0x83/0x90），错误码 0x01/0x02/0x03 分别表示非法功能、非法地址、非法数据值；按代码记录与提示
  - 状态监控：连续 N 次失败将通道标红，并触发日志与用户提示
