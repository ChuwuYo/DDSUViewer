# 项目简介
本项目是一个基于串口 Modbus RTU 的电参量采集与可视化桌面应用。

主要技术栈
- 后端：Go（Wails 桌面绑定），串口库：go.bug.st/serial
- 通信：Modbus RTU（CRC16，读寄存器）
- 前端：React + TypeScript + Vite + 组件库（通过 Wails JS 调用后端）

后端关键文件
- [`main.go`](main.go:1)：Wails 应用入口
- [`app.go`](app.go:1)：暴露给前端的方法（启动/停止轮询、配置等）
- [`internal/serial/serial.go`](internal/serial/serial.go:1)：串口打开/读写封装
- [`internal/modbus/modbus.go`](internal/modbus/modbus.go:1)：Modbus 帧构造与 CRC/响应解析
- [`internal/poller/poller.go`](internal/poller/poller.go:1)：轮询逻辑与重试/退避策略
- [`internal/registers/registers.go`](internal/registers/registers.go:1)：寄存器映射与 IEEE754 解析
- [`internal/service/service.go`](internal/service/service.go:1)：服务层，管理 poller 与订阅广播

前端关键文件
- [`frontend/src/main.tsx`](frontend/src/main.tsx:1)：前端入口，挂载 React、引入全局样式与主题
- [`frontend/src/App.tsx`](frontend/src/App.tsx:1)：主界面布局（顶部栏、Grid 布局）
- 组件：
  - [`frontend/src/components/SerialConfigPanel.tsx`](frontend/src/components/SerialConfigPanel.tsx:1)：串口配置与启动/停止逻辑，调用 Wails 后端方法
  - [`frontend/src/components/ElectricalDataPanel.tsx`](frontend/src/components/ElectricalDataPanel.tsx:1)：实时电参量展示，从 store 读取并渲染
- 轮询实现：[`frontend/src/store/appStore.ts`](frontend/src/store/appStore.ts:61)：startDataPolling 使用 window.setInterval（1000ms）调用后端的 GetElectricalData；组件通过 [`frontend/src/hooks/usePolling.ts`](frontend/src/hooks/usePolling.ts:1) 订阅 appStore 获取数据
- 包管理：[`frontend/package.json`](frontend/package.json:1)：依赖与脚本（dev/build/preview）

主要特性（简述）
- 前端定时轮询（默认 1s），每 N 次读能量数据
- 串口互斥保护，响应完整性校验（CRC）、异常码判断
- 寄存器按大端 IEEE754 解析为浮点数
- 前端可配置串口参数并保存快照（文件：data/saved_serial_config.json）

快速上手
- 开发：在项目根目录运行 `wails dev`（或先构建 frontend 后运行 Go 服务）
- 打包：`wails build`
- 常见问题：检查串口权限、设备地址与波特率、查看后端日志输出

数据读取与传输（关键流程）
- 总体流程（从设备到前端）
  1. 串口驱动层（低级 IO）：与设备建立串口连接并负责读写、超时与互斥。
     - 位置：[`internal/serial/serial.go`](internal/serial/serial.go:1)
  2. Poller（轮询层）：按配置周期发送 Modbus RTU 读寄存器请求，等待响应并进行帧完整性与 CRC 检查；发生异常时按照重试/退避策略处理。
     - 位置：[`internal/poller/poller.go`](internal/poller/poller.go:1)
  3. 寄存器解析：将 Modbus 寄存器原始字节转换为业务数值（包括大端 IEEE754 浮点解析、标度与单位转换）。
     - 位置：[`internal/registers/registers.go`](internal/registers/registers.go:1)
  4. Service 层（聚合与广播）：汇总解析后的业务值，缓存最新数据并通过内部订阅/广播机制向上层提供统一访问接口。
     - 位置：[`internal/service/service.go`](internal/service/service.go:1)
  5. Wails 暴露层（后端 -> 前端）：在 [`app.go`](app.go:1) 中暴露方法（例如 GetElectricalData、StartPolling、StopPolling），前端通过 Wails Runtime 调用这些方法获取或控制后端行为。
  6. 前端拉取与分发：前端由 [`frontend/src/store/appStore.ts`](frontend/src/store/appStore.ts:61) 的 startDataPolling 周期性调用后端导出方法（GetElectricalData）；获取到的数据在 store 内做格式化（formatNumber）与有效性校验（isValidElectricalData），然后通过 notifyListeners 通知订阅组件更新；组件一般通过 [`frontend/src/hooks/usePolling.ts`](frontend/src/hooks/usePolling.ts:1) 或直接订阅 store 来接收更新。

- 关键代码定位（便于快速查阅）
  - CRC 与帧解析：[`internal/modbus/modbus.go`](internal/modbus/modbus.go:1)
  - 串口 IO：[`internal/serial/serial.go`](internal/serial/serial.go:1)
  - 轮询入口与重试策略：[`internal/poller/poller.go`](internal/poller/poller.go:1)
  - 寄存器到业务值的转换：[`internal/registers/registers.go`](internal/registers/registers.go:1)
  - 服务层聚合与广播契约：[`internal/service/service.go`](internal/service/service.go:1)
  - 后端对外接口（Wails 导出）：[`app.go`](app.go:1)
  - 前端轮询与数据处理：[`frontend/src/store/appStore.ts`](frontend/src/store/appStore.ts:61)（startDataPolling / isValidElectricalData / formatNumber）
  - 前端订阅钩子：[`frontend/src/hooks/usePolling.ts`](frontend/src/hooks/usePolling.ts:1)
  - 调试用示例组件：[`frontend/src/components/ElectricalDataPanel.tsx`](frontend/src/components/ElectricalDataPanel.tsx:1)

- 实现要点与注意事项
  - 串口层负责帧边界与 CRC 校验，任何解析或业务逻辑假定收到的是完整且校验通过的帧；如果收到异常帧，应在 serial/poller 层记录并丢弃或触发重试。
  - Poller 应保证串口互斥访问（避免并发读写），并在长时间无响应时进行退避以避免占用总线。
  - 寄存器解析需明确字节序与标度（见 registers.go），对能量累计量要注意累加/清零边界与单位一致性。
  - Service 层负责聚合并保证对外方法（GetElectricalData）返回的对象结构稳定，前端仅做显示与轻量校验（isValidElectricalData），不要在前端做复杂的业务重算。
  - 前端轮询间隔默认 1s，可根据设备响应时间与性能调优；对于更实时或节能的场景，建议实现事件推送或条件性拉取替代固定频率轮询。

- 快速排查流程（当数据异常时）
  1. 在后端增加串口/Modbus 原始帧日志（[`internal/serial/serial.go`](internal/serial/serial.go:1) / [`internal/modbus/modbus.go`](internal/modbus/modbus.go:1)）。
  2. 验证 poller 的请求/响应序列与重试日志（[`internal/poller/poller.go`](internal/poller/poller.go:1)）。
  3. 检查 registers.go 的解析结果（是否字节序或寄存器偏移错误）。
  4. 在 service 层打印聚合后的对象，确认 app.go 返回的数据结构与预期一致（[`internal/service/service.go`](internal/service/service.go:1) / [`app.go`](app.go:1)）。
  5. 在前端（[`frontend/src/store/appStore.ts`](frontend/src/store/appStore.ts:61)）打印收到的原始对象并验证 isValidElectricalData 的判断逻辑。

- 安全与生产注意
  - 日志中避免输出可能的敏感串口原始数据（生产环境按需限制或脱敏）。
  - 后端导出接口应有必要的错误/超时保护，避免前端长期等待阻塞 UI。

保存位置
文档已更新并保存为 [`docs/介绍.md`](docs/介绍.md:1)
