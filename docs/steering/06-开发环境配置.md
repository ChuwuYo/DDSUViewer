# DDSUViewer 开发环境配置

## 环境要求

### 系统要求
- **操作系统**: Windows 10/11 (64位)
- **内存**: 最少 4GB RAM，推荐 8GB+
- **存储**: 至少 2GB 可用空间
- **网络**: 用于下载依赖包

### 硬件要求
- **串口**: RS485 串口或 USB 转 RS485 适配器
- **设备**: DDSU666 单相电子式电能表
- **连接线**: RS485 通信线缆

## 开发工具安装

### 1. Go 语言环境

#### 下载安装
```bash
# 访问官网下载 Go 1.23+
https://golang.org/dl/

# 或使用包管理器 (Windows)
winget install GoLang.Go

# 验证安装
go version
```

#### 环境变量配置
```bash
# 设置 GOPATH (可选，Go 1.11+ 支持模块)
set GOPATH=C:\Users\%USERNAME%\go

# 设置 GOPROXY (加速国内下载)
go env -w GOPROXY=https://goproxy.cn,direct
go env -w GOSUMDB=sum.golang.google.cn

# 启用模块支持
go env -w GO111MODULE=on
```

### 2. Node.js 环境

#### 下载安装
```bash
# 访问官网下载 Node.js 16+
https://nodejs.org/

# 或使用包管理器
winget install OpenJS.NodeJS

# 验证安装
node --version
npm --version
```

#### NPM 配置
```bash
# 设置国内镜像源
npm config set registry https://registry.npmmirror.com

# 或使用 yarn
npm install -g yarn
yarn config set registry https://registry.npmmirror.com
```

### 3. Wails CLI 工具

#### 安装 Wails
```bash
# 安装 Wails CLI
go install github.com/wailsapp/wails/v2/cmd/wails@latest

# 验证安装
wails version

# 检查依赖
wails doctor
```

#### Wails 依赖检查
```bash
# 运行依赖检查，确保所有工具已安装
wails doctor

# 输出示例:
# ✓ Go version: go1.23.0
# ✓ Node.js version: v18.17.0
# ✓ npm version: 9.6.7
# ✓ Wails version: v2.10.2
```

### 4. 开发工具推荐

#### VS Code 配置
```json
// .vscode/settings.json
{
  "go.toolsManagement.checkForUpdates": "local",
  "go.useLanguageServer": true,
  "go.gopath": "",
  "go.goroot": "",
  "go.lintTool": "golangci-lint",
  "go.formatTool": "goimports",
  "typescript.preferences.importModuleSpecifier": "relative",
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.organizeImports": true
  }
}
```

#### VS Code 扩展推荐
```json
// .vscode/extensions.json
{
  "recommendations": [
    "golang.go",
    "ms-vscode.vscode-typescript-next",
    "bradlc.vscode-tailwindcss",
    "esbenp.prettier-vscode",
    "ms-vscode.vscode-json"
  ]
}
```

#### GoLand 配置
- 启用 Go Modules 支持
- 配置 GOPROXY 代理
- 安装 Wails 插件
- 配置代码格式化工具

## 项目初始化

### 1. 克隆项目
```bash
# 克隆仓库
git clone https://github.com/ChuwuYo/DDSUViewer.git
cd DDSUViewer

# 查看项目结构
tree /f
```

### 2. 后端依赖安装
```bash
# 下载 Go 模块依赖
go mod download

# 验证依赖
go mod verify

# 整理依赖
go mod tidy
```

### 3. 前端依赖安装
```bash
# 进入前端目录
cd frontend

# 安装 npm 依赖
npm install

# 或使用 yarn
yarn install

# 返回项目根目录
cd ..
```

### 4. 验证环境
```bash
# 检查 Wails 项目配置
wails doctor

# 构建测试
wails build --dry-run
```

## 开发模式启动

### 1. 开发服务器启动
```bash
# 启动开发模式 (热重载)
wails dev

# 指定端口启动
wails dev -port 3000

# 详细日志模式
wails dev -v
```

### 2. 分离式开发
```bash
# 终端1: 启动前端开发服务器
cd frontend
npm run dev

# 终端2: 启动后端服务
go run .

# 终端3: 启动 Wails 开发模式
wails dev -frontend http://localhost:5173
```

### 3. 调试配置

#### VS Code 调试配置
```json
// .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug DDSUViewer",
      "type": "go",
      "request": "launch",
      "mode": "debug",
      "program": "${workspaceFolder}",
      "env": {
        "CGO_ENABLED": "1"
      },
      "args": []
    },
    {
      "name": "Debug Frontend",
      "type": "node",
      "request": "launch",
      "cwd": "${workspaceFolder}/frontend",
      "runtimeExecutable": "npm",
      "runtimeArgs": ["run", "dev"]
    }
  ]
}
```

#### GoLand 调试配置
- 创建 Go Build 配置
- 设置工作目录为项目根目录
- 启用 CGO 支持
- 配置环境变量

## 构建配置

### 1. 开发构建
```bash
# 开发构建 (包含调试信息)
wails build

# 指定输出目录
wails build -o ./dist/

# 跳过前端构建 (前端已构建)
wails build -skipbindings
```

### 2. 生产构建
```bash
# 生产构建 (优化版本)
wails build -ldflags="-s -w"

# 带版本号构建
wails build -ldflags="-X main.Version=1.0.0"

# 压缩构建 (需要 UPX)
wails build -ldflags="-s -w" -upx

# 完整生产构建
wails build -ldflags="-s -w -X main.Version=1.0.0" -upx -clean
```

### 3. 构建脚本

#### Windows 批处理脚本
```batch
@echo off
REM build.bat

set VERSION=%1
if "%VERSION%"=="" set VERSION=dev

echo Building DDSUViewer v%VERSION%...

REM 清理旧构建
if exist "build" rmdir /s /q build

REM 安装前端依赖
cd frontend
call npm install
cd ..

REM 构建应用
wails build -ldflags="-s -w -X main.Version=%VERSION%" -clean

echo Build completed: build/bin/DDSUViewer.exe
pause
```

#### PowerShell 脚本
```powershell
# build.ps1
param(
    [string]$Version = "dev",
    [switch]$Clean,
    [switch]$Compress
)

Write-Host "Building DDSUViewer v$Version..." -ForegroundColor Green

# 清理构建目录
if ($Clean -and (Test-Path "build")) {
    Remove-Item -Recurse -Force "build"
}

# 安装前端依赖
Set-Location "frontend"
npm install
Set-Location ".."

# 构建参数
$buildArgs = @(
    "build",
    "-ldflags=`"-s -w -X main.Version=$Version`"",
    "-clean"
)

if ($Compress) {
    $buildArgs += "-upx"
}

# 执行构建
& wails $buildArgs

Write-Host "Build completed!" -ForegroundColor Green
```

## 测试配置

### 1. 单元测试
```bash
# 运行所有测试
go test ./...

# 运行特定包测试
go test ./internal/modbus

# 带覆盖率测试
go test -cover ./...

# 生成覆盖率报告
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

### 2. 集成测试
```bash
# 运行集成测试 (需要硬件)
go test -tags=integration ./...

# 模拟测试
go test -tags=mock ./...
```

### 3. 前端测试
```bash
cd frontend

# 运行单元测试
npm test

# 运行 E2E 测试
npm run test:e2e

# 生成测试报告
npm run test:coverage
```

## 代码质量工具

### 1. Go 代码检查
```bash
# 安装 golangci-lint
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

# 运行代码检查
golangci-lint run

# 自动修复
golangci-lint run --fix
```

#### golangci-lint 配置
```yaml
# .golangci.yml
run:
  timeout: 5m
  tests: true

linters:
  enable:
    - gofmt
    - goimports
    - govet
    - errcheck
    - staticcheck
    - unused
    - gosimple
    - structcheck
    - varcheck
    - ineffassign
    - deadcode

linters-settings:
  gofmt:
    simplify: true
  goimports:
    local-prefixes: DDSUViewer
```

### 2. 前端代码检查
```bash
cd frontend

# 安装 ESLint 和 Prettier
npm install --save-dev eslint prettier

# 运行 ESLint
npm run lint

# 自动修复
npm run lint:fix

# 格式化代码
npm run format
```

#### ESLint 配置
```json
// frontend/.eslintrc.json
{
  "extends": [
    "react-app",
    "react-app/jest",
    "@typescript-eslint/recommended"
  ],
  "rules": {
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/explicit-function-return-type": "off",
    "react-hooks/exhaustive-deps": "warn"
  }
}
```

## 版本控制配置

### 1. Git 配置
```bash
# 设置用户信息
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 设置默认分支
git config --global init.defaultBranch main

# 设置换行符处理 (Windows)
git config --global core.autocrlf true
```

### 2. .gitignore 配置
```gitignore
# DDSUViewer .gitignore

# Binaries for programs and plugins
*.exe
*.exe~
*.dll
*.so
*.dylib

# Test binary, built with `go test -c`
*.test

# Output of the go coverage tool
*.out
coverage.html

# Go workspace file
go.work

# Wails build directory
build/
app.syso

# Frontend
frontend/dist/
frontend/node_modules/
frontend/.vite/

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Logs
*.log

# Environment variables
.env
.env.local
```

### 3. 提交规范
```bash
# 提交消息格式
git commit -m "feat: 添加串口自动检测功能"
git commit -m "fix: 修复Modbus CRC校验错误"
git commit -m "docs: 更新API文档"
git commit -m "style: 统一代码格式"
git commit -m "refactor: 重构数据轮询逻辑"
git commit -m "test: 添加单元测试"
```

## 常见问题解决

### 1. Go 模块问题
```bash
# 清理模块缓存
go clean -modcache

# 重新下载依赖
go mod download

# 更新依赖
go get -u ./...
```

### 2. Wails 构建问题
```bash
# 清理 Wails 缓存
wails clean

# 重新生成绑定
wails generate

# 检查 WebView2 (Windows)
wails doctor
```

### 3. 前端依赖问题
```bash
cd frontend

# 清理 node_modules
rm -rf node_modules package-lock.json

# 重新安装
npm install

# 或使用 yarn
yarn install --force
```

### 4. 串口权限问题
```bash
# Windows: 以管理员身份运行
# Linux: 添加用户到 dialout 组
sudo usermod -a -G dialout $USER

# 重新登录生效
```

### 5. 防火墙问题
```bash
# Windows Defender 防火墙
# 添加应用到防火墙例外列表

# 企业防火墙
# 配置代理设置
go env -w GOPROXY=https://goproxy.cn,direct
npm config set proxy http://proxy.company.com:8080
```

## 性能优化建议

### 1. 构建优化
```bash
# 使用构建缓存
go env -w GOCACHE=/path/to/cache

# 并行构建
go build -p 4

# 链接器优化
go build -ldflags="-s -w"
```

### 2. 开发优化
```bash
# 使用本地代理
go env -w GOPROXY=https://goproxy.cn,direct

# 启用模块缓存
go env -w GOMODCACHE=/path/to/modcache

# 前端开发服务器优化
npm config set cache /path/to/npm-cache
```

### 3. 调试优化
```bash
# 启用详细日志
wails dev -v

# 使用 pprof 性能分析
go tool pprof http://localhost:6060/debug/pprof/profile

# 内存分析
go tool pprof http://localhost:6060/debug/pprof/heap
```

## 部署准备

### 1. 依赖检查
```bash
# 检查运行时依赖
ldd DDSUViewer.exe  # Linux
otool -L DDSUViewer  # macOS

# Windows 依赖
# 确保目标机器安装了 WebView2 Runtime
```

### 2. 配置文件
```json
// config.json
{
  "logLevel": "info",
  "maxRetries": 3,
  "timeout": 5000,
  "serialDefaults": {
    "baudRate": 9600,
    "dataBits": 8,
    "stopBits": 1,
    "parity": "None"
  }
}
```

### 3. 安装包制作
```bash
# 使用 NSIS (Windows)
makensis installer.nsi

# 使用 Inno Setup (Windows)
iscc installer.iss

# 使用 WiX Toolset (Windows MSI)
candle installer.wxs
light installer.wixobj
```