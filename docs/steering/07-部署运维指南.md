# DDSUViewer 部署运维指南

## 部署概述

DDSUViewer 是一个桌面应用程序，主要部署在 Windows 环境中。本指南涵盖应用程序的打包、分发、安装、配置和维护等各个方面。

## 构建和打包

### 1. 生产构建

#### 标准构建
```bash
# 基础生产构建
wails build -clean

# 优化构建 (减小文件大小)
wails build -ldflags="-s -w" -clean

# 带版本信息构建
wails build -ldflags="-s -w -X main.Version=1.0.0" -clean

# 压缩构建 (需要 UPX)
wails build -ldflags="-s -w -X main.Version=1.0.0" -upx -clean
```

#### 自动化构建脚本
```powershell
# build-release.ps1
param(
    [Parameter(Mandatory=$true)]
    [string]$Version,
    [string]$OutputDir = "release",
    [switch]$Compress
)

Write-Host "Building DDSUViewer v$Version for release..." -ForegroundColor Green

# 清理输出目录
if (Test-Path $OutputDir) {
    Remove-Item -Recurse -Force $OutputDir
}
New-Item -ItemType Directory -Path $OutputDir

# 构建参数
$ldflags = "-s -w -X main.Version=$Version"
$buildArgs = @("build", "-ldflags=$ldflags", "-clean", "-o", "$OutputDir/DDSUViewer.exe")

if ($Compress) {
    $buildArgs += "-upx"
}

# 执行构建
& wails $buildArgs

if ($LASTEXITCODE -eq 0) {
    Write-Host "Build successful!" -ForegroundColor Green
    
    # 复制必要文件
    Copy-Item "README.md" "$OutputDir/"
    Copy-Item "LICENSE" "$OutputDir/"
    Copy-Item "docs/用户手册.pdf" "$OutputDir/" -ErrorAction SilentlyContinue
    
    # 创建版本信息文件
    @"
DDSUViewer v$Version
构建时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
构建环境: Windows $(Get-WmiObject Win32_OperatingSystem | Select-Object -ExpandProperty Version)
Go 版本: $(go version)
"@ | Out-File -FilePath "$OutputDir/VERSION.txt" -Encoding UTF8
    
    Write-Host "Release package created in $OutputDir/" -ForegroundColor Green
} else {
    Write-Host "Build failed!" -ForegroundColor Red
    exit 1
}
```

### 2. 交叉编译

#### Windows 平台
```bash
# Windows x64
GOOS=windows GOARCH=amd64 wails build -ldflags="-s -w"

# Windows x86 (32位)
GOOS=windows GOARCH=386 wails build -ldflags="-s -w"

# Windows ARM64
GOOS=windows GOARCH=arm64 wails build -ldflags="-s -w"
```

#### 其他平台 (实验性)
```bash
# Linux x64
GOOS=linux GOARCH=amd64 wails build -ldflags="-s -w"

# macOS x64
GOOS=darwin GOARCH=amd64 wails build -ldflags="-s -w"

# macOS ARM64 (Apple Silicon)
GOOS=darwin GOARCH=arm64 wails build -ldflags="-s -w"
```

### 3. 构建验证

#### 自动化测试脚本
```powershell
# test-build.ps1
param([string]$BuildPath = "build/bin/DDSUViewer.exe")

Write-Host "Testing build: $BuildPath" -ForegroundColor Yellow

# 检查文件是否存在
if (-not (Test-Path $BuildPath)) {
    Write-Host "Build file not found: $BuildPath" -ForegroundColor Red
    exit 1
}

# 检查文件大小
$fileSize = (Get-Item $BuildPath).Length / 1MB
Write-Host "File size: $([math]::Round($fileSize, 2)) MB"

# 检查文件签名 (如果有)
$signature = Get-AuthenticodeSignature $BuildPath
Write-Host "Signature status: $($signature.Status)"

# 检查依赖 (使用 Dependency Walker 或类似工具)
# dumpbin /dependents $BuildPath

# 基本功能测试 (启动应用并快速退出)
Write-Host "Testing application startup..."
$process = Start-Process -FilePath $BuildPath -ArgumentList "--test-mode" -PassThru -WindowStyle Hidden
Start-Sleep -Seconds 5
if (-not $process.HasExited) {
    $process.Kill()
    Write-Host "Application started successfully" -ForegroundColor Green
} else {
    Write-Host "Application failed to start" -ForegroundColor Red
    exit 1
}

Write-Host "Build test completed successfully!" -ForegroundColor Green
```

## 安装包制作

### 1. NSIS 安装包

#### 安装脚本 (installer.nsi)
```nsis
; DDSUViewer NSIS 安装脚本
!define APPNAME "DDSUViewer"
!define COMPANYNAME "ChuwuYo"
!define DESCRIPTION "DDSU666 电能表上位机"
!define VERSIONMAJOR 1
!define VERSIONMINOR 0
!define VERSIONBUILD 0

!define HELPURL "https://github.com/ChuwuYo/DDSUViewer"
!define UPDATEURL "https://github.com/ChuwuYo/DDSUViewer/releases"
!define ABOUTURL "https://github.com/ChuwuYo/DDSUViewer"

!define INSTALLSIZE 50000 ; KB

RequestExecutionLevel admin
InstallDir "$PROGRAMFILES64\${COMPANYNAME}\${APPNAME}"

Name "${APPNAME}"
Icon "appicon.ico"
outFile "${APPNAME}-${VERSIONMAJOR}.${VERSIONMINOR}.${VERSIONBUILD}-setup.exe"

!include LogicLib.nsh
!include MUI2.nsh

; 界面配置
!define MUI_ABORTWARNING
!define MUI_ICON "appicon.ico"
!define MUI_UNICON "appicon.ico"

; 安装页面
!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE "LICENSE"
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

; 卸载页面
!insertmacro MUI_UNPAGE_WELCOME
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES
!insertmacro MUI_UNPAGE_FINISH

!insertmacro MUI_LANGUAGE "SimpChinese"

Section "install"
    ; 设置输出路径
    SetOutPath $INSTDIR
    
    ; 复制文件
    File "DDSUViewer.exe"
    File "README.md"
    File "LICENSE"
    File /nonfatal "用户手册.pdf"
    
    ; 创建开始菜单快捷方式
    CreateDirectory "$SMPROGRAMS\${COMPANYNAME}"
    CreateShortCut "$SMPROGRAMS\${COMPANYNAME}\${APPNAME}.lnk" "$INSTDIR\DDSUViewer.exe"
    CreateShortCut "$SMPROGRAMS\${COMPANYNAME}\卸载 ${APPNAME}.lnk" "$INSTDIR\uninstall.exe"
    
    ; 创建桌面快捷方式
    CreateShortCut "$DESKTOP\${APPNAME}.lnk" "$INSTDIR\DDSUViewer.exe"
    
    ; 写入注册表
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayName" "${APPNAME}"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "UninstallString" "$\"$INSTDIR\uninstall.exe$\""
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "QuietUninstallString" "$\"$INSTDIR\uninstall.exe$\" /S"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "InstallLocation" "$\"$INSTDIR$\""
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayIcon" "$\"$INSTDIR\DDSUViewer.exe$\""
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "Publisher" "${COMPANYNAME}"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "HelpLink" "${HELPURL}"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "URLUpdateInfo" "${UPDATEURL}"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "URLInfoAbout" "${ABOUTURL}"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayVersion" "${VERSIONMAJOR}.${VERSIONMINOR}.${VERSIONBUILD}"
    WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "VersionMajor" ${VERSIONMAJOR}
    WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "VersionMinor" ${VERSIONMINOR}
    WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "NoModify" 1
    WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "NoRepair" 1
    WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "EstimatedSize" ${INSTALLSIZE}
    
    ; 创建卸载程序
    WriteUninstaller "$INSTDIR\uninstall.exe"
SectionEnd

Section "uninstall"
    ; 删除文件
    Delete "$INSTDIR\DDSUViewer.exe"
    Delete "$INSTDIR\README.md"
    Delete "$INSTDIR\LICENSE"
    Delete "$INSTDIR\用户手册.pdf"
    Delete "$INSTDIR\uninstall.exe"
    
    ; 删除快捷方式
    Delete "$SMPROGRAMS\${COMPANYNAME}\${APPNAME}.lnk"
    Delete "$SMPROGRAMS\${COMPANYNAME}\卸载 ${APPNAME}.lnk"
    Delete "$DESKTOP\${APPNAME}.lnk"
    RMDir "$SMPROGRAMS\${COMPANYNAME}"
    
    ; 删除安装目录
    RMDir "$INSTDIR"
    
    ; 删除注册表项
    DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}"
SectionEnd
```

#### 构建安装包
```bash
# 使用 NSIS 编译安装包
makensis installer.nsi

# 或使用 PowerShell
& "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi
```

### 2. Inno Setup 安装包

#### 安装脚本 (installer.iss)
```ini
; DDSUViewer Inno Setup 脚本
[Setup]
AppId={{12345678-1234-1234-1234-123456789012}
AppName=DDSUViewer
AppVersion=1.0.0
AppPublisher=ChuwuYo
AppPublisherURL=https://github.com/ChuwuYo/DDSUViewer
AppSupportURL=https://github.com/ChuwuYo/DDSUViewer/issues
AppUpdatesURL=https://github.com/ChuwuYo/DDSUViewer/releases
DefaultDirName={autopf}\ChuwuYo\DDSUViewer
DefaultGroupName=DDSUViewer
AllowNoIcons=yes
LicenseFile=LICENSE
OutputDir=release
OutputBaseFilename=DDSUViewer-1.0.0-setup
SetupIconFile=appicon.ico
Compression=lzma
SolidCompression=yes
WizardStyle=modern
PrivilegesRequired=admin
ArchitecturesAllowed=x64
ArchitecturesInstallIn64BitMode=x64

[Languages]
Name: "chinesesimp"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"

[Tasks]
Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

[Files]
Source: "DDSUViewer.exe"; DestDir: "{app}"; Flags: ignoreversion
Source: "README.md"; DestDir: "{app}"; Flags: ignoreversion
Source: "LICENSE"; DestDir: "{app}"; Flags: ignoreversion
Source: "用户手册.pdf"; DestDir: "{app}"; Flags: ignoreversion skipifsourcedoesntexist

[Icons]
Name: "{group}\DDSUViewer"; Filename: "{app}\DDSUViewer.exe"
Name: "{group}\{cm:UninstallProgram,DDSUViewer}"; Filename: "{uninstallexe}"
Name: "{autodesktop}\DDSUViewer"; Filename: "{app}\DDSUViewer.exe"; Tasks: desktopicon

[Run]
Filename: "{app}\DDSUViewer.exe"; Description: "{cm:LaunchProgram,DDSUViewer}"; Flags: nowait postinstall skipifsilent

[Code]
// 检查 WebView2 Runtime
function IsWebView2Installed: Boolean;
var
  Version: String;
begin
  Result := RegQueryStringValue(HKLM, 'SOFTWARE\WOW6432Node\Microsoft\EdgeUpdate\Clients\{F3017226-FE2A-4295-8BDF-00C3A9A7E4C5}', 'pv', Version);
  if not Result then
    Result := RegQueryStringValue(HKLM, 'SOFTWARE\Microsoft\EdgeUpdate\Clients\{F3017226-FE2A-4295-8BDF-00C3A9A7E4C5}', 'pv', Version);
end;

function InitializeSetup: Boolean;
begin
  Result := True;
  if not IsWebView2Installed then
  begin
    if MsgBox('此应用程序需要 Microsoft Edge WebView2 Runtime。是否要下载并安装？', mbConfirmation, MB_YESNO) = IDYES then
    begin
      ShellExec('open', 'https://go.microsoft.com/fwlink/p/?LinkId=2124703', '', '', SW_SHOWNORMAL, ewNoWait, ErrorCode);
    end;
  end;
end;
```

### 3. MSI 安装包 (WiX Toolset)

#### 产品定义 (Product.wxs)
```xml
<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" Name="DDSUViewer" Language="2052" Version="1.0.0" 
           Manufacturer="ChuwuYo" UpgradeCode="12345678-1234-1234-1234-123456789012">
    
    <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />
    
    <MajorUpgrade DowngradeErrorMessage="已安装更新版本的 DDSUViewer。" />
    <MediaTemplate EmbedCab="yes" />
    
    <Feature Id="ProductFeature" Title="DDSUViewer" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
    </Feature>
    
    <!-- UI -->
    <UIRef Id="WixUI_InstallDir" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    
    <!-- License -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    
    <!-- Icon -->
    <Icon Id="AppIcon" SourceFile="appicon.ico" />
    <Property Id="ARPPRODUCTICON" Value="AppIcon" />
    
  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="CompanyFolder" Name="ChuwuYo">
          <Directory Id="INSTALLFOLDER" Name="DDSUViewer" />
        </Directory>
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="DDSUViewer"/>
      </Directory>
      <Directory Id="DesktopFolder" Name="Desktop" />
    </Directory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="MainExecutable" Guid="*">
        <File Id="DDSUViewerExe" Source="DDSUViewer.exe" KeyPath="yes">
          <Shortcut Id="ApplicationStartMenuShortcut" Directory="ApplicationProgramsFolder" 
                    Name="DDSUViewer" WorkingDirectory="INSTALLFOLDER" Icon="AppIcon" IconIndex="0" Advertise="yes" />
          <Shortcut Id="ApplicationDesktopShortcut" Directory="DesktopFolder" 
                    Name="DDSUViewer" WorkingDirectory="INSTALLFOLDER" Icon="AppIcon" IconIndex="0" Advertise="yes" />
        </File>
      </Component>
      
      <Component Id="Documentation" Guid="*">
        <File Id="ReadmeFile" Source="README.md" KeyPath="yes" />
        <File Id="LicenseFile" Source="LICENSE" />
      </Component>
      
      <Component Id="ProgramMenuDir" Directory="ApplicationProgramsFolder" Guid="*">
        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU" Key="Software\ChuwuYo\DDSUViewer" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </ComponentGroup>
  </Fragment>
</Wix>
```

## 部署策略

### 1. 单机部署

#### 绿色版部署
```powershell
# create-portable.ps1
param([string]$Version = "1.0.0")

$portableDir = "DDSUViewer-$Version-Portable"

# 创建便携版目录
New-Item -ItemType Directory -Path $portableDir -Force

# 复制文件
Copy-Item "build/bin/DDSUViewer.exe" "$portableDir/"
Copy-Item "README.md" "$portableDir/"
Copy-Item "LICENSE" "$portableDir/"

# 创建配置文件
@"
{
  "portable": true,
  "dataDir": "./data",
  "logLevel": "info",
  "serialDefaults": {
    "baudRate": 9600,
    "dataBits": 8,
    "stopBits": 1,
    "parity": "None",
    "slaveID": 12
  }
}
"@ | Out-File -FilePath "$portableDir/config.json" -Encoding UTF8

# 创建启动脚本
@"
@echo off
echo Starting DDSUViewer...
DDSUViewer.exe
pause
"@ | Out-File -FilePath "$portableDir/start.bat" -Encoding ASCII

# 创建数据目录
New-Item -ItemType Directory -Path "$portableDir/data" -Force

Write-Host "Portable version created: $portableDir" -ForegroundColor Green
```

#### 系统服务部署 (可选)
```powershell
# install-service.ps1
param(
    [string]$ServiceName = "DDSUViewerService",
    [string]$DisplayName = "DDSU666 电能表监控服务",
    [string]$ExePath = "C:\Program Files\ChuwuYo\DDSUViewer\DDSUViewer.exe"
)

# 检查管理员权限
if (-NOT ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Host "需要管理员权限来安装服务" -ForegroundColor Red
    exit 1
}

# 安装服务
New-Service -Name $ServiceName -BinaryPathName "$ExePath --service" -DisplayName $DisplayName -StartupType Automatic -Description "DDSU666 单相电子式电能表数据采集服务"

Write-Host "服务安装成功: $DisplayName" -ForegroundColor Green
Write-Host "使用以下命令管理服务:" -ForegroundColor Yellow
Write-Host "  启动: Start-Service $ServiceName"
Write-Host "  停止: Stop-Service $ServiceName"
Write-Host "  卸载: Remove-Service $ServiceName"
```

### 2. 网络部署

#### 网络共享部署
```batch
REM deploy-network.bat
@echo off
set NETWORK_PATH=\\server\software\DDSUViewer
set LOCAL_PATH=C:\Program Files\ChuwuYo\DDSUViewer

echo Deploying DDSUViewer from network share...

REM 创建本地目录
if not exist "%LOCAL_PATH%" mkdir "%LOCAL_PATH%"

REM 复制文件
xcopy "%NETWORK_PATH%\*" "%LOCAL_PATH%\" /E /Y /I

REM 创建快捷方式
powershell -Command "$WshShell = New-Object -comObject WScript.Shell; $Shortcut = $WshShell.CreateShortcut('%USERPROFILE%\Desktop\DDSUViewer.lnk'); $Shortcut.TargetPath = '%LOCAL_PATH%\DDSUViewer.exe'; $Shortcut.Save()"

echo Deployment completed!
pause
```

#### 自动更新机制
```go
// updater.go
package main

import (
    "encoding/json"
    "fmt"
    "io"
    "net/http"
    "os"
    "path/filepath"
    "time"
)

type UpdateInfo struct {
    Version     string `json:"version"`
    DownloadURL string `json:"download_url"`
    Changelog   string `json:"changelog"`
    Required    bool   `json:"required"`
}

func CheckForUpdates(currentVersion string) (*UpdateInfo, error) {
    resp, err := http.Get("https://api.github.com/repos/ChuwuYo/DDSUViewer/releases/latest")
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()

    var release struct {
        TagName string `json:"tag_name"`
        Assets  []struct {
            Name               string `json:"name"`
            BrowserDownloadURL string `json:"browser_download_url"`
        } `json:"assets"`
        Body string `json:"body"`
    }

    if err := json.NewDecoder(resp.Body).Decode(&release); err != nil {
        return nil, err
    }

    if release.TagName == currentVersion {
        return nil, nil // 已是最新版本
    }

    // 查找 Windows 安装包
    var downloadURL string
    for _, asset := range release.Assets {
        if filepath.Ext(asset.Name) == ".exe" {
            downloadURL = asset.BrowserDownloadURL
            break
        }
    }

    return &UpdateInfo{
        Version:     release.TagName,
        DownloadURL: downloadURL,
        Changelog:   release.Body,
        Required:    false,
    }, nil
}

func DownloadUpdate(url, filename string) error {
    resp, err := http.Get(url)
    if err != nil {
        return err
    }
    defer resp.Body.Close()

    file, err := os.Create(filename)
    if err != nil {
        return err
    }
    defer file.Close()

    _, err = io.Copy(file, resp.Body)
    return err
}
```

## 配置管理

### 1. 配置文件结构

#### 主配置文件 (config.json)
```json
{
  "version": "1.0.0",
  "application": {
    "title": "DDSUViewer",
    "logLevel": "info",
    "logFile": "logs/ddsuviewer.log",
    "maxLogSize": "10MB",
    "maxLogFiles": 5,
    "dataDir": "./data",
    "configDir": "./config"
  },
  "serial": {
    "defaults": {
      "baudRate": 9600,
      "dataBits": 8,
      "stopBits": 1,
      "parity": "None",
      "slaveID": 12
    },
    "timeout": 5000,
    "maxRetries": 3,
    "retryDelay": 50
  },
  "polling": {
    "electricalDataInterval": 1000,
    "energyDataInterval": 10000,
    "maxDataAge": 30000
  },
  "ui": {
    "theme": "light",
    "language": "zh-CN",
    "windowSize": {
      "width": 1024,
      "height": 768
    },
    "autoStart": false,
    "minimizeToTray": false
  },
  "network": {
    "proxy": {
      "enabled": false,
      "host": "",
      "port": 0,
      "username": "",
      "password": ""
    },
    "updateCheck": {
      "enabled": true,
      "interval": 86400,
      "url": "https://api.github.com/repos/ChuwuYo/DDSUViewer/releases/latest"
    }
  }
}
```

#### 设备配置文件 (devices.json)
```json
{
  "devices": [
    {
      "id": "device001",
      "name": "主配电柜电表",
      "model": "DDSU666",
      "serialConfig": {
        "port": "COM1",
        "baudRate": 9600,
        "dataBits": 8,
        "stopBits": 1,
        "parity": "None",
        "slaveID": 12
      },
      "registers": {
        "voltage": "0x2000",
        "current": "0x2002",
        "activePower": "0x2004",
        "reactivePower": "0x2006",
        "apparentPower": "0x2008",
        "powerFactor": "0x200A",
        "frequency": "0x200E",
        "activeEnergy": "0x4000"
      },
      "enabled": true,
      "description": "主配电柜DDSU666电能表"
    }
  ]
}
```

### 2. 配置管理工具

#### 配置验证脚本
```powershell
# validate-config.ps1
param([string]$ConfigPath = "config.json")

function Test-ConfigFile {
    param([string]$Path)
    
    if (-not (Test-Path $Path)) {
        Write-Host "配置文件不存在: $Path" -ForegroundColor Red
        return $false
    }
    
    try {
        $config = Get-Content $Path | ConvertFrom-Json
        Write-Host "配置文件格式正确: $Path" -ForegroundColor Green
        
        # 验证必需字段
        $requiredFields = @("version", "application", "serial", "polling")
        foreach ($field in $requiredFields) {
            if (-not $config.$field) {
                Write-Host "缺少必需字段: $field" -ForegroundColor Red
                return $false
            }
        }
        
        # 验证串口配置
        if ($config.serial.defaults.baudRate -notin @(4800, 9600, 19200, 38400, 115200)) {
            Write-Host "无效的波特率: $($config.serial.defaults.baudRate)" -ForegroundColor Red
            return $false
        }
        
        Write-Host "配置验证通过" -ForegroundColor Green
        return $true
    }
    catch {
        Write-Host "配置文件格式错误: $($_.Exception.Message)" -ForegroundColor Red
        return $false
    }
}

Test-ConfigFile $ConfigPath
```

#### 配置备份脚本
```powershell
# backup-config.ps1
param(
    [string]$ConfigDir = ".",
    [string]$BackupDir = "backup"
)

$timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
$backupPath = "$BackupDir/config-backup-$timestamp"

# 创建备份目录
New-Item -ItemType Directory -Path $backupPath -Force

# 备份配置文件
$configFiles = @("config.json", "devices.json", "users.json")
foreach ($file in $configFiles) {
    if (Test-Path "$ConfigDir/$file") {
        Copy-Item "$ConfigDir/$file" "$backupPath/"
        Write-Host "已备份: $file" -ForegroundColor Green
    }
}

# 创建备份信息文件
@"
备份时间: $(Get-Date)
备份版本: $(if (Test-Path "$ConfigDir/config.json") { (Get-Content "$ConfigDir/config.json" | ConvertFrom-Json).version } else { "未知" })
备份文件: $($configFiles -join ", ")
"@ | Out-File -FilePath "$backupPath/backup-info.txt" -Encoding UTF8

Write-Host "配置备份完成: $backupPath" -ForegroundColor Green
```

## 监控和维护

### 1. 日志管理

#### 日志配置
```go
// logger.go
package main

import (
    "log/slog"
    "os"
    "path/filepath"
    "gopkg.in/natefinch/lumberjack.v2"
)

func setupLogger(config LogConfig) {
    // 确保日志目录存在
    logDir := filepath.Dir(config.LogFile)
    if err := os.MkdirAll(logDir, 0755); err != nil {
        panic(err)
    }

    // 配置日志轮转
    logger := &lumberjack.Logger{
        Filename:   config.LogFile,
        MaxSize:    config.MaxSize,    // MB
        MaxBackups: config.MaxBackups,
        MaxAge:     config.MaxAge,     // days
        Compress:   true,
    }

    // 设置日志级别
    var level slog.Level
    switch config.Level {
    case "debug":
        level = slog.LevelDebug
    case "info":
        level = slog.LevelInfo
    case "warn":
        level = slog.LevelWarn
    case "error":
        level = slog.LevelError
    default:
        level = slog.LevelInfo
    }

    handler := slog.NewJSONHandler(logger, &slog.HandlerOptions{
        Level: level,
    })

    slog.SetDefault(slog.New(handler))
}

type LogConfig struct {
    LogFile    string
    Level      string
    MaxSize    int
    MaxBackups int
    MaxAge     int
}
```

#### 日志分析脚本
```powershell
# analyze-logs.ps1
param(
    [string]$LogFile = "logs/ddsuviewer.log",
    [int]$Days = 7
)

if (-not (Test-Path $LogFile)) {
    Write-Host "日志文件不存在: $LogFile" -ForegroundColor Red
    exit 1
}

$startDate = (Get-Date).AddDays(-$Days)
$logs = Get-Content $LogFile | Where-Object { $_ -match '^\d{4}-\d{2}-\d{2}' }

# 统计错误
$errors = $logs | Where-Object { $_ -match '"level":"ERROR"' }
Write-Host "错误数量 (最近 $Days 天): $($errors.Count)" -ForegroundColor Red

# 统计警告
$warnings = $logs | Where-Object { $_ -match '"level":"WARN"' }
Write-Host "警告数量 (最近 $Days 天): $($warnings.Count)" -ForegroundColor Yellow

# 统计连接失败
$connectionErrors = $logs | Where-Object { $_ -match '串口.*失败|连接.*失败' }
Write-Host "连接失败次数: $($connectionErrors.Count)" -ForegroundColor Red

# 统计数据采集成功率
$totalRequests = $logs | Where-Object { $_ -match '数据采集|读取寄存器' }
$successRequests = $logs | Where-Object { $_ -match '数据采集.*成功|读取.*成功' }
if ($totalRequests.Count -gt 0) {
    $successRate = [math]::Round(($successRequests.Count / $totalRequests.Count) * 100, 2)
    Write-Host "数据采集成功率: $successRate%" -ForegroundColor Green
}

# 最近的错误
Write-Host "`n最近的错误:" -ForegroundColor Red
$errors | Select-Object -Last 5 | ForEach-Object {
    Write-Host "  $_" -ForegroundColor Red
}
```

### 2. 性能监控

#### 性能指标收集
```go
// metrics.go
package main

import (
    "runtime"
    "sync/atomic"
    "time"
)

type Metrics struct {
    // 应用指标
    StartTime       time.Time
    TotalRequests   int64
    SuccessRequests int64
    FailedRequests  int64
    
    // 性能指标
    AvgResponseTime int64 // 纳秒
    MaxResponseTime int64
    MinResponseTime int64
    
    // 系统指标
    MemoryUsage     uint64
    GoroutineCount  int
    GCCount         uint32
}

var appMetrics = &Metrics{
    StartTime:       time.Now(),
    MinResponseTime: int64(^uint64(0) >> 1), // 最大int64值
}

func RecordRequest(duration time.Duration, success bool) {
    atomic.AddInt64(&appMetrics.TotalRequests, 1)
    
    if success {
        atomic.AddInt64(&appMetrics.SuccessRequests, 1)
    } else {
        atomic.AddInt64(&appMetrics.FailedRequests, 1)
    }
    
    // 更新响应时间统计
    durationNs := duration.Nanoseconds()
    
    // 更新平均响应时间 (简单移动平均)
    currentAvg := atomic.LoadInt64(&appMetrics.AvgResponseTime)
    newAvg := (currentAvg + durationNs) / 2
    atomic.StoreInt64(&appMetrics.AvgResponseTime, newAvg)
    
    // 更新最大响应时间
    for {
        currentMax := atomic.LoadInt64(&appMetrics.MaxResponseTime)
        if durationNs <= currentMax {
            break
        }
        if atomic.CompareAndSwapInt64(&appMetrics.MaxResponseTime, currentMax, durationNs) {
            break
        }
    }
    
    // 更新最小响应时间
    for {
        currentMin := atomic.LoadInt64(&appMetrics.MinResponseTime)
        if durationNs >= currentMin {
            break
        }
        if atomic.CompareAndSwapInt64(&appMetrics.MinResponseTime, currentMin, durationNs) {
            break
        }
    }
}

func UpdateSystemMetrics() {
    var m runtime.MemStats
    runtime.ReadMemStats(&m)
    
    atomic.StoreUint64(&appMetrics.MemoryUsage, m.Alloc)
    atomic.StoreInt64((*int64)(&appMetrics.GoroutineCount), int64(runtime.NumGoroutine()))
    atomic.StoreUint32(&appMetrics.GCCount, m.NumGC)
}

func GetMetrics() map[string]interface{} {
    UpdateSystemMetrics()
    
    uptime := time.Since(appMetrics.StartTime)
    totalReq := atomic.LoadInt64(&appMetrics.TotalRequests)
    successReq := atomic.LoadInt64(&appMetrics.SuccessRequests)
    
    var successRate float64
    if totalReq > 0 {
        successRate = float64(successReq) / float64(totalReq) * 100
    }
    
    return map[string]interface{}{
        "uptime":           uptime.String(),
        "totalRequests":    totalReq,
        "successRequests":  successReq,
        "failedRequests":   atomic.LoadInt64(&appMetrics.FailedRequests),
        "successRate":      successRate,
        "avgResponseTime":  time.Duration(atomic.LoadInt64(&appMetrics.AvgResponseTime)).String(),
        "maxResponseTime":  time.Duration(atomic.LoadInt64(&appMetrics.MaxResponseTime)).String(),
        "minResponseTime":  time.Duration(atomic.LoadInt64(&appMetrics.MinResponseTime)).String(),
        "memoryUsage":      atomic.LoadUint64(&appMetrics.MemoryUsage),
        "goroutineCount":   atomic.LoadInt64((*int64)(&appMetrics.GoroutineCount)),
        "gcCount":          atomic.LoadUint32(&appMetrics.GCCount),
    }
}
```

### 3. 健康检查

#### 健康检查脚本
```powershell
# health-check.ps1
param(
    [string]$ProcessName = "DDSUViewer",
    [string]$LogFile = "logs/ddsuviewer.log",
    [int]$MaxMemoryMB = 500,
    [int]$MaxLogAgeDays = 1
)

function Test-ProcessHealth {
    $process = Get-Process -Name $ProcessName -ErrorAction SilentlyContinue
    
    if (-not $process) {
        Write-Host "❌ 进程未运行: $ProcessName" -ForegroundColor Red
        return $false
    }
    
    Write-Host "✅ 进程运行正常: $ProcessName (PID: $($process.Id))" -ForegroundColor Green
    
    # 检查内存使用
    $memoryMB = [math]::Round($process.WorkingSet64 / 1MB, 2)
    if ($memoryMB -gt $MaxMemoryMB) {
        Write-Host "⚠️  内存使用过高: $memoryMB MB (限制: $MaxMemoryMB MB)" -ForegroundColor Yellow
    } else {
        Write-Host "✅ 内存使用正常: $memoryMB MB" -ForegroundColor Green
    }
    
    return $true
}

function Test-LogHealth {
    if (-not (Test-Path $LogFile)) {
        Write-Host "❌ 日志文件不存在: $LogFile" -ForegroundColor Red
        return $false
    }
    
    $logAge = (Get-Date) - (Get-Item $LogFile).LastWriteTime
    if ($logAge.TotalDays -gt $MaxLogAgeDays) {
        Write-Host "⚠️  日志文件过旧: $([math]::Round($logAge.TotalHours, 1)) 小时前" -ForegroundColor Yellow
        return $false
    }
    
    Write-Host "✅ 日志文件正常: $([math]::Round($logAge.TotalMinutes, 1)) 分钟前更新" -ForegroundColor Green
    return $true
}

function Test-ConfigHealth {
    $configFile = "config.json"
    if (-not (Test-Path $configFile)) {
        Write-Host "❌ 配置文件不存在: $configFile" -ForegroundColor Red
        return $false
    }
    
    try {
        $config = Get-Content $configFile | ConvertFrom-Json
        Write-Host "✅ 配置文件正常" -ForegroundColor Green
        return $true
    }
    catch {
        Write-Host "❌ 配置文件格式错误: $($_.Exception.Message)" -ForegroundColor Red
        return $false
    }
}

# 执行健康检查
Write-Host "DDSUViewer 健康检查" -ForegroundColor Cyan
Write-Host "===================" -ForegroundColor Cyan

$processOK = Test-ProcessHealth
$logOK = Test-LogHealth
$configOK = Test-ConfigHealth

Write-Host "`n总体状态:" -ForegroundColor Cyan
if ($processOK -and $logOK -and $configOK) {
    Write-Host "✅ 系统运行正常" -ForegroundColor Green
    exit 0
} else {
    Write-Host "❌ 系统存在问题" -ForegroundColor Red
    exit 1
}
```

### 4. 自动维护

#### 维护脚本
```powershell
# maintenance.ps1
param(
    [switch]$CleanLogs,
    [switch]$BackupConfig,
    [switch]$UpdateCheck,
    [switch]$RestartService
)

function Invoke-LogCleanup {
    Write-Host "清理旧日志文件..." -ForegroundColor Yellow
    
    $logDir = "logs"
    if (Test-Path $logDir) {
        $oldLogs = Get-ChildItem $logDir -Filter "*.log.*" | Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-30) }
        foreach ($log in $oldLogs) {
            Remove-Item $log.FullName -Force
            Write-Host "已删除: $($log.Name)" -ForegroundColor Green
        }
    }
}

function Invoke-ConfigBackup {
    Write-Host "备份配置文件..." -ForegroundColor Yellow
    & .\backup-config.ps1
}

function Invoke-UpdateCheck {
    Write-Host "检查更新..." -ForegroundColor Yellow
    # 实现更新检查逻辑
}

function Invoke-ServiceRestart {
    Write-Host "重启服务..." -ForegroundColor Yellow
    
    $serviceName = "DDSUViewerService"
    $service = Get-Service -Name $serviceName -ErrorAction SilentlyContinue
    
    if ($service) {
        Restart-Service -Name $serviceName -Force
        Write-Host "服务已重启: $serviceName" -ForegroundColor Green
    } else {
        Write-Host "服务不存在: $serviceName" -ForegroundColor Red
    }
}

# 执行维护任务
Write-Host "DDSUViewer 系统维护" -ForegroundColor Cyan
Write-Host "===================" -ForegroundColor Cyan

if ($CleanLogs) { Invoke-LogCleanup }
if ($BackupConfig) { Invoke-ConfigBackup }
if ($UpdateCheck) { Invoke-UpdateCheck }
if ($RestartService) { Invoke-ServiceRestart }

Write-Host "维护任务完成" -ForegroundColor Green
```

## 故障排除

### 1. 常见问题诊断

#### 诊断脚本
```powershell
# diagnose.ps1
Write-Host "DDSUViewer 故障诊断" -ForegroundColor Cyan
Write-Host "===================" -ForegroundColor Cyan

# 检查进程状态
$process = Get-Process -Name "DDSUViewer" -ErrorAction SilentlyContinue
if ($process) {
    Write-Host "✅ 应用程序正在运行 (PID: $($process.Id))" -ForegroundColor Green
} else {
    Write-Host "❌ 应用程序未运行" -ForegroundColor Red
}

# 检查端口占用
$comPorts = [System.IO.Ports.SerialPort]::getportnames()
Write-Host "可用串口: $($comPorts -join ', ')" -ForegroundColor Yellow

# 检查WebView2
$webview2 = Get-ItemProperty "HKLM:\SOFTWARE\WOW6432Node\Microsoft\EdgeUpdate\Clients\{F3017226-FE2A-4295-8BDF-00C3A9A7E4C5}" -Name "pv" -ErrorAction SilentlyContinue
if ($webview2) {
    Write-Host "✅ WebView2 已安装: $($webview2.pv)" -ForegroundColor Green
} else {
    Write-Host "❌ WebView2 未安装" -ForegroundColor Red
}

# 检查防火墙
$firewallRules = Get-NetFirewallRule -DisplayName "*DDSUViewer*" -ErrorAction SilentlyContinue
if ($firewallRules) {
    Write-Host "✅ 防火墙规则已配置" -ForegroundColor Green
} else {
    Write-Host "⚠️  未找到防火墙规则" -ForegroundColor Yellow
}

# 检查事件日志
$events = Get-WinEvent -FilterHashtable @{LogName='Application'; ProviderName='DDSUViewer'} -MaxEvents 5 -ErrorAction SilentlyContinue
if ($events) {
    Write-Host "最近的应用程序事件:" -ForegroundColor Yellow
    $events | ForEach-Object {
        Write-Host "  $($_.TimeCreated): $($_.LevelDisplayName) - $($_.Message)" -ForegroundColor Gray
    }
}
```

### 2. 自动恢复

#### 监控和恢复脚本
```powershell
# monitor-and-recover.ps1
param(
    [int]$CheckInterval = 60,  # 秒
    [int]$MaxRestarts = 3,
    [string]$ProcessName = "DDSUViewer",
    [string]$ExePath = "C:\Program Files\ChuwuYo\DDSUViewer\DDSUViewer.exe"
)

$restartCount = 0
$lastRestartTime = Get-Date

while ($true) {
    $process = Get-Process -Name $ProcessName -ErrorAction SilentlyContinue
    
    if (-not $process) {
        Write-Host "$(Get-Date): 进程未运行，尝试重启..." -ForegroundColor Yellow
        
        if ($restartCount -lt $MaxRestarts) {
            try {
                Start-Process -FilePath $ExePath -WindowStyle Hidden
                $restartCount++
                $lastRestartTime = Get-Date
                Write-Host "$(Get-Date): 进程已重启 ($restartCount/$MaxRestarts)" -ForegroundColor Green
            }
            catch {
                Write-Host "$(Get-Date): 重启失败: $($_.Exception.Message)" -ForegroundColor Red
            }
        } else {
            Write-Host "$(Get-Date): 达到最大重启次数，停止监控" -ForegroundColor Red
            break
        }
    } else {
        # 重置重启计数器 (如果进程运行超过1小时)
        if ((Get-Date) - $lastRestartTime -gt (New-TimeSpan -Hours 1)) {
            $restartCount = 0
        }
        
        Write-Host "$(Get-Date): 进程运行正常 (PID: $($process.Id))" -ForegroundColor Green
    }
    
    Start-Sleep -Seconds $CheckInterval
}
```

这份部署运维指南涵盖了 DDSUViewer 从构建打包到生产部署的完整流程，包括安装包制作、配置管理、监控维护和故障排除等关键环节，为项目的稳定运行提供了全面的技术支持。