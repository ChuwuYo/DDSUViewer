# DDSUViewer 技术架构设计

## 架构概览

DDSUViewer 采用分层架构设计，通过 Wails v2 框架实现前后端分离，确保代码的可维护性和扩展性。

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    前端层 (Frontend)                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 数据展示组件 │  │ 配置管理组件 │  │ 状态监控组件 │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           状态管理 (AppStore)                       │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ Wails Bridge
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (App Layer)                       │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Wails App (app.go)                     │   │
│  │  - GetAvailablePorts()                              │   │
│  │  - GetElectricalData()                              │   │
│  │  - StartPolling() / StopPolling()                   │   │
│  │  - UpdateSerialConfig()                             │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   业务逻辑层 (Service Layer)                 │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Service Manager                        │   │
│  │  - 串口连接管理                                      │   │
│  │  - 数据轮询控制                                      │   │
│  │  - 配置管理                                          │   │
│  │  - 状态管理                                          │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   数据处理层 (Data Layer)                   │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Poller    │  │   Parser    │  │  Registers  │         │
│  │  数据轮询    │  │  数据解析    │  │  寄存器定义  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   通信层 (Communication Layer)              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐                          │
│  │   Serial    │  │   Modbus    │                          │
│  │  串口通信    │  │  协议处理    │                          │
│  └─────────────┘  └─────────────┘                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   硬件层 (Hardware Layer)                   │
├─────────────────────────────────────────────────────────────┤
│              DDSU666 电能表 (RS485)                         │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件设计

### 1. 前端架构 (Frontend)

#### 组件结构
```typescript
src/
├── components/
│   ├── ElectricalDataPanel.tsx    # 电参量数据展示
│   ├── SerialConfigPanel.tsx      # 串口配置面板
│   └── StatusPanel.tsx            # 状态监控面板
├── hooks/
│   └── usePolling.ts              # 数据轮询 Hook
├── store/
│   └── appStore.ts                # 全局状态管理
└── theme/
    └── colors.ts                  # Material Design 3 色彩系统
```

#### 状态管理设计
```typescript
interface AppState {
  status: DeviceStatus;           // 设备连接状态
  data: ElectricalData | null;    // 电参量数据
  config: SerialConfig;           // 串口配置
}

interface DeviceStatus {
  connected: boolean;             // 连接状态
  protocol: string;               // 协议类型
  lastUpdate: string;             // 最后更新时间
  errorMessage?: string;          // 错误信息
}
```

### 2. 应用层 (App Layer)

#### Wails 绑定方法
```go
// app.go - Wails 应用入口
type App struct {
    ctx     context.Context
    service *service.Service
}

// 对外暴露的方法
func (a *App) GetAvailablePorts() []string
func (a *App) GetElectricalData() map[string]interface{}
func (a *App) StartPolling() bool
func (a *App) StopPolling() bool
func (a *App) UpdateSerialConfig(...) bool
```

### 3. 业务逻辑层 (Service Layer)

#### 服务管理器设计
```go
type Service struct {
    conn         *serial.Connection      // 串口连接
    poller       *poller.Poller         // 数据轮询器
    config       *SerialConfig          // 串口配置
    status       *DeviceStatus          // 设备状态
    lastData     *ElectricalData        // 最新数据
    mutex        sync.RWMutex           // 读写锁
    subscribers  map[string]chan *ElectricalData  // 数据订阅者
    statusSubs   map[string]chan *DeviceStatus    // 状态订阅者
}
```

#### 核心功能
- **连接管理**: 串口连接的打开、关闭和状态监控
- **配置管理**: 串口参数的动态配置和验证
- **数据管理**: 电参量数据的缓存和分发
- **订阅机制**: 支持多个订阅者的数据推送

### 4. 数据处理层 (Data Layer)

#### 轮询器 (Poller)
```go
type Poller struct {
    conn     *serial.Connection
    slaveID  byte
    running  bool
    ctx      context.Context
    cancel   context.CancelFunc
    dataChan chan *registers.ElectricalData
}
```

**轮询策略**:
- 电参量数据: 1秒周期轮询 (0x2000-0x200F)
- 电能数据: 10秒周期轮询 (0x4000)
- 重试机制: 最多3次重试，每次间隔50ms

#### 数据解析器 (Parser)
```go
// 解析 IEEE754 浮点数 (DDSU666 特定字节序)
func ParseFloat32(data []byte) float32 {
    // 字节序转换: [1,0,3,2] -> [0,1,2,3]
    bytes := make([]byte, 4)
    bytes[0] = data[1]  // 第一个寄存器低字节
    bytes[1] = data[0]  // 第一个寄存器高字节
    bytes[2] = data[3]  // 第二个寄存器低字节
    bytes[3] = data[2]  // 第二个寄存器高字节
    
    bits := binary.LittleEndian.Uint32(bytes)
    return math.Float32frombits(bits)
}
```

#### 寄存器定义 (Registers)
```go
const (
    RegVoltage       = 0x2000  // 电压
    RegCurrent       = 0x2002  // 电流
    RegActivePower   = 0x2004  // 有功功率
    RegReactivePower = 0x2006  // 无功功率
    RegApparentPower = 0x2008  // 视在功率
    RegPowerFactor   = 0x200A  // 功率因数
    RegFrequency     = 0x200E  // 频率
    RegActiveEnergy  = 0x4000  // 有功总电能
)
```

### 5. 通信层 (Communication Layer)

#### 串口通信 (Serial)
```go
type Connection struct {
    port   serial.Port
    config Config
    mutex  sync.Mutex
    isOpen bool
}

type Config struct {
    Port     string
    BaudRate int
    DataBits int
    StopBits serial.StopBits
    Parity   serial.Parity
}
```

**特性**:
- 线程安全的读写操作
- 超时控制机制
- 自动端口检测
- 连接状态管理

#### Modbus RTU 协议
```go
type Frame struct {
    SlaveID  byte    // 从站地址
    Function byte    // 功能码 (0x03)
    Data     []byte  // 数据域
    CRC      uint16  // CRC16 校验
}
```

**协议实现**:
- CRC16 校验算法
- 帧构造和解析
- 异常响应处理
- 超时重传机制

## 数据流设计

### 1. 数据采集流程
```
1. Poller 定时触发
2. 构造 Modbus 请求帧
3. 通过 Serial 发送到设备
4. 接收设备响应
5. 解析 Modbus 响应帧
6. 转换寄存器数据为浮点数
7. 更新 Service 中的数据缓存
8. 通知前端数据更新
```

### 2. 配置更新流程
```
1. 前端配置变更
2. 调用 Wails 绑定方法
3. Service 验证配置参数
4. 停止当前轮询 (如果运行中)
5. 关闭当前串口连接
6. 更新配置参数
7. 重新建立连接 (如果需要)
```

### 3. 错误处理流程
```
1. 检测通信错误
2. 更新设备状态
3. 记录错误信息
4. 通知前端显示错误
5. 自动重试机制
6. 连接恢复检测
```

## 性能优化设计

### 1. 并发控制
- 使用 `sync.RWMutex` 保护共享数据
- 独立的轮询 goroutine
- 非阻塞的数据通道通信

### 2. 内存管理
- 数据缓存复用
- 及时释放不用的连接
- 限制通道缓冲区大小

### 3. 通信优化
- 批量读取寄存器减少通信次数
- 智能重试机制避免无效请求
- 超时控制防止阻塞

## 扩展性设计

### 1. 协议扩展
- 抽象的协议接口设计
- 支持添加其他 Modbus 设备
- 可配置的寄存器映射

### 2. 界面扩展
- 组件化的前端设计
- 主题系统支持
- 响应式布局适配

### 3. 功能扩展
- 数据导出功能预留接口
- 历史数据存储设计
- 报警系统架构预留